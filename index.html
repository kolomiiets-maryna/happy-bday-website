<!DOCTYPE html>
<html>
<head>
    <title>🎂 Happy Birthday!</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <h1>🎉 Happy Birthday, Ari! 🎉</h1>
    <h2> Make a wish and blow the candles!</h2>
    
    
    <div class="cake">
        <div class="cake-base">
            <div class="icing">
                <div class="drip"></div>
                <div class="drip"></div>
                <div class="drip"></div>
                <div class="drip"></div>
                <div class="drip"></div>
                <div class="drip"></div>
            </div>
            <div class="cream-drip"></div>
            <div class="cream"></div>
        </div>
        <div class="candles-cont">
            <div class="candle">
                <div class="firepit">
                    <div class="fire">
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                    </div>
                </div>
            </div>
            <div class="candle">
                <div class="firepit">
                    <div class="fire">
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                    </div>
                </div>
            </div>
            <div class="candle">
                <div class="firepit">
                    <div class="fire">
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                        <div class="flame" id="flame-id"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<button onclick="startMic()" class="mic-button">Start Microphone</button>

    <div id="message">🎊 Woohoo! 🎊 <br>May all your wishes come true ❤️ <br> - Marina</div>

<script>
        let audioContext;
        let analyser;
        let microphone;
        let isMicActive = false;
        let candlesBlown = false;

        async function startMic() {
            if (!isMicActive && !candlesBlown) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);

                    isMicActive = true;
                    document.querySelector('button[onclick="startMic()"]').textContent = 'Stop Microphone';

                    // start listening microphone
                    // microphone.on('sound-detected', analyzeVolume)
                    analyzeVolume();
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    alert('Could not access microphone. Please ensure microphone access is allowed.');
                }
            } else {
                stopMic();
            }
        }

        function stopMic() {
            if (microphone) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
                audioContext.close();
                isMicActive = false;
                document.querySelector('button[onclick="startMic()"]').textContent = 'Start Microphone';
                document.querySelector('button[onclick="startMic()"]').style = 'background-color: rgb(199, 199, 199);';
                resetFlames();
            }
        }

        function analyzeVolume() {
            if (!isMicActive || candlesBlown) return;

            console.log('analyzeVolume +++++')
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;
            const volume = average / 255; // Normalize to 0-1

            const flames = document.querySelectorAll('.fire .flame');
            flames.forEach(flame => {
                if (volume > 0.1) { // Threshold for leaning
                    const leanAngle = Math.min(40 * volume, 90); // Max 30 degrees lean
                    flame.style.transform = `rotate(${leanAngle - 45}deg) skew(-10deg, -10deg)`;
                    flame.classList.add('dynamic');
                } else {
                    flame.style.transform = `rotate(-45deg) skew(-10deg, -10deg)`;
                    flame.classList.remove('dynamic');
                }
            });

            if (volume > 0.3) { // Threshold for blowing out candles
                blowCandles();
            } else {
                requestAnimationFrame(analyzeVolume);
            }
        }

        function resetFlames() {
            const flames = document.querySelectorAll('.fire .flame');
            flames.forEach(flame => {
                flame.style.transform = `rotate(-45deg) skew(-10deg, -10deg)`;
                flame.classList.remove('dynamic');
            });
        }

        function blowCandles() {
            if (candlesBlown) return;
            candlesBlown = true;
            const flames = document.querySelectorAll('.fire .flame');
            flames.forEach((flame, index) => {
                flame.style.animation = index % 2 === 0 ? 'fly-up-burnout-1 0s forwards' : 'fly-up-burnout-2 0s forwards';
                });
            document.getElementById('message').style.display = 'block';
            stopMic();
        }
    </script>

</body>
</html>
