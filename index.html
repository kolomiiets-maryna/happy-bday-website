<!DOCTYPE html>
<html>
<head>
    <title>üéÇ Happy Birthday!</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <h1>üéâ Happy Birthday, Ari! üéâ</h1>
        <h2> Make a wish and blow the candles!</h2>
        
    
        <div class="cake">
            <div class="cake-base">
                <div class="icing">
                    <div class="drip"></div>
                    <div class="drip"></div>
                    <div class="drip"></div>
                    <div class="drip"></div>
                    <div class="drip"></div>
                    <div class="drip"></div>
                </div>
                <div class="cream-drip"></div>
                <div class="cream"></div>
            </div>
            <div class="candles-cont">
                <div class="candle">
                    <div class="firepit">
                        <div class="fire">
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                        </div>
                    </div>
                </div>
                <div class="candle">
                    <div class="firepit">
                        <div class="fire">
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                        </div>
                    </div>
                </div>
                <div class="candle">
                    <div class="firepit">
                        <div class="fire">
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                            <div class="flame" id="flame-id"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="startMic()" class="mic-button">Start Microphone</button>

        <div id="message">üéä Yeyyy! üéä <br>May all your wishes come true! <br> Sending you virtual kisses and hugs ‚ù§Ô∏è <br> And good luck on your exams üçÄ <br></div>
        <div id="sign">„ÄúMarina üíï</div>

    </div>
<script>
        let audioContext;
        let analyser;
        let microphone;
        let isMicActive = false;
        let candlesBlown = false;

        async function startMic() {
            if (!isMicActive && !candlesBlown) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);

                    isMicActive = true;
                    document.querySelector('button[onclick="startMic()"]').textContent = 'Stop Microphone';

                    // start listening microphone
                    // microphone.on('sound-detected', analyzeVolume)
                    analyzeVolume();
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    alert('Could not access microphone. Please ensure microphone access is allowed.');
                }
            } else {
                stopMic();
            }
        }

        function stopMic() {
            if (microphone) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
                audioContext.close();
                isMicActive = false;
                document.querySelector('button[onclick="startMic()"]').textContent = 'Start Microphone';
                document.querySelector('button[onclick="startMic()"]').style = 'background-color: rgb(199, 199, 199);';
                resetFlames();
            }
        }

        function analyzeVolume() {
            if (!isMicActive || candlesBlown) return;

            console.log('analyzeVolume +++++')
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;
            const volume = average / 255; // Normalize to 0-1

            const flames = document.querySelectorAll('.fire .flame');
            flames.forEach(flame => {
                if (volume > 0.3) { // Threshold for leaning
                    const leanAngle = Math.min(40 * volume, 90); // Max 30 degrees lean
                    flame.style.transform = `rotate(${leanAngle - 45}deg) skew(-10deg, -10deg)`;
                    flame.classList.add('dynamic');
                } else {
                    flame.style.transform = `rotate(-45deg) skew(-10deg, -10deg)`;
                    flame.classList.remove('dynamic');
                }
            });

            if (volume > 0.5) { // Threshold for blowing out candles
                blowCandles();
            } else {
                requestAnimationFrame(analyzeVolume);
            }
        }

        function resetFlames() {
            const flames = document.querySelectorAll('.fire .flame');
            flames.forEach(flame => {
                flame.style.transform = `rotate(-45deg) skew(-10deg, -10deg)`;
                flame.classList.remove('dynamic');
            });
        }

        function blowCandles() {
            if (candlesBlown) return;
            candlesBlown = true;
            const flames = document.querySelectorAll('.fire .flame');
            flames.forEach((flame, index) => {
                flame.style.animation = index % 2 === 0 ? 'fly-up-burnout-1 0s forwards' : 'fly-up-burnout-2 0s forwards';
                });
            document.getElementById('message').style.display = 'block';
            document.getElementById('sign').style.display = 'block';
            document.getElementById('canvas').style.display = 'block';

            stopMic();
        }

        let W = window.innerWidth;
let H = window.innerHeight;
const canvas = document.getElementById("canvas");
const context = canvas.getContext("2d");
const maxConfettis = 150;
const particles = [];

const possibleColors = [
  "DodgerBlue",
  "OliveDrab",
  "Gold",
  "Pink",
  "SlateBlue",
  "LightBlue",
  "Gold",
  "Violet",
  "PaleGreen",
  "SteelBlue",
  "SandyBrown",
  "Chocolate",
  "Crimson"
];

function randomFromTo(from, to) {
  return Math.floor(Math.random() * (to - from + 1) + from);
}

function confettiParticle() {
  this.x = Math.random() * W; // x
  this.y = Math.random() * H - H; // y
  this.r = randomFromTo(11, 33); // radius
  this.d = Math.random() * maxConfettis + 11;
  this.color =
    possibleColors[Math.floor(Math.random() * possibleColors.length)];
  this.tilt = Math.floor(Math.random() * 33) - 11;
  this.tiltAngleIncremental = Math.random() * 0.07 + 0.05;
  this.tiltAngle = 0;

  this.draw = function() {
    context.beginPath();
    context.lineWidth = this.r / 2;
    context.strokeStyle = this.color;
    context.moveTo(this.x + this.tilt + this.r / 3, this.y);
    context.lineTo(this.x + this.tilt, this.y + this.tilt + this.r / 5);
    return context.stroke();
  };
}

function Draw() {
  const results = [];

  // Magical recursive functional love
  requestAnimationFrame(Draw);

  context.clearRect(0, 0, W, window.innerHeight);

  for (var i = 0; i < maxConfettis; i++) {
    results.push(particles[i].draw());
  }

  let particle = {};
  let remainingFlakes = 0;
  for (var i = 0; i < maxConfettis; i++) {
    particle = particles[i];

    particle.tiltAngle += particle.tiltAngleIncremental;
    particle.y += (Math.cos(particle.d) + 3 + particle.r / 2) / 2;
    particle.tilt = Math.sin(particle.tiltAngle - i / 3) * 15;

    if (particle.y <= H) remainingFlakes++;

    // If a confetti has fluttered out of view,
    // bring it back to above the viewport and let if re-fall.
    if (particle.x > W + 30 || particle.x < -30 || particle.y > H) {
      particle.x = Math.random() * W;
      particle.y = -30;
      particle.tilt = Math.floor(Math.random() * 10) - 20;
    }
  }

  return results;
}

window.addEventListener(
  "resize",
  function() {
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  },
  false
);

// Push new confetti objects to `particles[]`
for (var i = 0; i < maxConfettis; i++) {
  particles.push(new confettiParticle());
}

// Initialize
canvas.width = W;
canvas.height = H;
Draw();

    </script>

</body>
</html>
